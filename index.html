<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TF2 Key Price Checker</title>
    <!-- اتصال به Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Vazirmatn", sans-serif;
      }
      /* استایل برای انیمیشن لودینگ */
      .loader {
        border: 4px solid #f3f3f3;
        border-radius: 50%;
        border-top: 4px solid #3498db;
        width: 40px;
        height: 40px;
        animation: spin 2s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body
    class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4"
  >
    <div
      class="w-full max-w-md mx-auto p-8 bg-gray-800 rounded-2xl shadow-lg text-center"
    >
      <!-- لوگو و عنوان -->
      <img
        src="https://wiki.teamfortress.com/w/images/thumb/6/69/Item_icon_Mann_Co._Supply_Crate_Key.png/250px-Item_icon_Mann_Co._Supply_Crate_Key.png"
        alt="TF2 Key"
        class="mx-auto w-24 h-24 mb-4"
        onerror="this.onerror=null;this.src='https://placehold.co/96x96/1f2937/ffffff?text=TF2+Key';"
      />

      <h1 class="text-3xl font-bold mb-2 text-yellow-400">
        Team Fortress 2 Key Price
      </h1>

      <!-- نمایشگر قیمت استیم -->
      <p class="text-gray-400 mb-2">
        Live price on Steam Market (Ukraine region)
      </p>
      <div
        id="price-display"
        class="bg-gray-700 p-6 rounded-lg mb-6 min-h-[100px] flex items-center justify-center"
      >
        <span id="price-text" class="text-4xl font-bold text-gray-500"
          >...</span
        >
        <div id="loader" class="loader hidden"></div>
      </div>

      <!-- Net received (Steam fees) -->
      <div class="mt-4 text-sm text-gray-300 text-left">
        <label for="buyer-price" class="block font-semibold mb-1">Buyer price per key (USD)</label>
        <input id="buyer-price" type="number" step="0.01" value="2.50" class="w-full bg-gray-700 rounded px-3 py-2 focus:outline-none" />
        <p id="net-received" class="mt-2">Net received per key: $2.13 (15% fees)</p>
        <p class="text-xs text-gray-400 mt-1">Steam takes 5% and TF2 takes 10% from sales.</p>
        <p class="text-xs text-gray-400 mt-1"><strong>Example:</strong> $2.50 × 0.85 = $2.125 ≈ $2.13</p>
      </div>

      <!-- نمایشگر قیمت EasyKeys -->
      <div class="mt-8 border-t border-gray-700 pt-6">
        <h2 class="text-2xl font-bold mb-2 text-cyan-400">
          Price on EasyKeys.ir
        </h2>
        <div
          id="easykeys-price-display"
          class="bg-gray-700 p-6 rounded-lg mb-6 min-h-[100px] flex items-center justify-center"
        >
          <span
            id="easykeys-price-text"
            class="text-4xl font-bold text-gray-500"
            >...</span
          >
          <div id="easykeys-loader" class="loader hidden"></div>
        </div>
        <p id="easykeys-error-message" class="text-red-500 mt-4 h-5"></p>

        <!-- Keys needed calculator -->
        <div class="mt-4 text-sm text-gray-300 text-left">
          <label for="game-price" class="block font-semibold mb-1">Game price (USD)</label>
          <input id="game-price" type="number" step="0.01" placeholder="e.g., 59.99" class="w-full bg-gray-700 rounded px-3 py-2 focus:outline-none" />
          <p id="keys-needed" class="mt-2">Keys needed: —</p>
          <p class="text-xs text-gray-400 mt-1">Calculated using net received per key after Steam fees.</p>
        </div>
      </div>

      <!-- دکمه برای دریافت قیمت -->
      <button
        id="fetch-price-btn"
        class="w-full mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105"
      >
        Refresh Prices
      </button>
    </div>

    <script>
      // المنت های صفحه (استیم)
      const fetchButton = document.getElementById("fetch-price-btn");
      const priceText = document.getElementById("price-text");
      const loader = document.getElementById("loader");

      // المنت های صفحه (EasyKeys)
      const easyKeysPriceText = document.getElementById("easykeys-price-text");
      const easyKeysErrorMessage = document.getElementById(
        "easykeys-error-message"
      );
      const easyKeysLoader = document.getElementById("easykeys-loader");

      // آدرس فانکشن ها در Netlify
      const steamApiUrl = "/.netlify/functions/getPrice";
      const easyKeysApiUrl = "/.netlify/functions/getEasyKeysPrice";

      // Fetch Steam price
      async function fetchSteamPrice() {
        priceText.classList.add("hidden");
        loader.classList.remove("hidden");

        try {
          const response = await fetch(steamApiUrl);
          const data = await response.json();
          if (!response.ok || !data.success)
            throw new Error(data.message || "Steam response was unsuccessful.");

          priceText.textContent = data.lowest_price;
          priceText.classList.remove("text-gray-500", "text-red-500");
          priceText.classList.add("text-green-400");
        } catch (error) {
          console.error("Error fetching Steam data:", error);
          priceText.textContent = "Error!";
          priceText.classList.remove("text-green-400");
          priceText.classList.add("text-red-500");
        } finally {
          loader.classList.add("hidden");
          priceText.classList.remove("hidden");
        }
      }

      // Fetch EasyKeys price
      async function fetchEasyKeysPrice() {
        easyKeysPriceText.classList.add("hidden");
        easyKeysLoader.classList.remove("hidden");
        easyKeysErrorMessage.textContent = "";

        try {
          const response = await fetch(easyKeysApiUrl);
          const data = await response.json();
          if (!response.ok || !data.success)
            throw new Error(data.message || "EasyKeys response was unsuccessful.");

          easyKeysPriceText.textContent = `${data.price} Toman`;
          easyKeysPriceText.classList.remove("text-gray-500", "text-red-500");
          easyKeysPriceText.classList.add("text-teal-300");
        } catch (error) {
          console.error("Error fetching EasyKeys data:", error);
          easyKeysErrorMessage.textContent = "Error fetching EasyKeys price.";
          easyKeysPriceText.textContent = "Error!";
          easyKeysPriceText.classList.remove("text-teal-300");
          easyKeysPriceText.classList.add("text-red-500");
        } finally {
          easyKeysLoader.classList.add("hidden");
          easyKeysPriceText.classList.remove("hidden");
        }
      }

      // Net received computation
      const buyerPriceInput = document.getElementById("buyer-price");
      const netReceivedText = document.getElementById("net-received");
      const gamePriceInput = document.getElementById("game-price");
      const keysNeededText = document.getElementById("keys-needed");

      function computeNetUSD() {
        const buyer = parseFloat(buyerPriceInput.value || "0");
        if (isNaN(buyer) || buyer <= 0) return 0;
        return buyer * 0.85; // 15% total fees
      }

      function updateNetReceived() {
        const net = computeNetUSD();
        if (net > 0) {
          netReceivedText.textContent = `Net received per key: $${net.toFixed(2)} (15% fees)`;
        } else {
          netReceivedText.textContent = "Net received per key: —";
        }
      }

      function updateKeysNeeded() {
        const net = computeNetUSD();
        const game = parseFloat(gamePriceInput.value || "0");
        if (!net || !game || isNaN(game) || game <= 0) {
          keysNeededText.textContent = "Keys needed: —";
          return;
        }
        const needed = Math.ceil(game / net);
        keysNeededText.textContent = `Keys needed: ${needed}`;
      }

      function fetchAllPrices() {
        fetchButton.disabled = true;
        fetchButton.classList.add("opacity-50", "cursor-not-allowed");

        // اجرای همزمان هر دو فانکشن
        Promise.all([fetchSteamPrice(), fetchEasyKeysPrice()]).finally(() => {
          fetchButton.disabled = false;
          fetchButton.classList.remove("opacity-50", "cursor-not-allowed");
          updateNetReceived();
          updateKeysNeeded();
        });
      }

      // افزودن رویداد کلیک به دکمه
      fetchButton.addEventListener("click", () => { fetchAllPrices(); });
      buyerPriceInput.addEventListener("input", () => { updateNetReceived(); updateKeysNeeded(); });
      gamePriceInput.addEventListener("input", updateKeysNeeded);

      // دریافت قیمت در اولین بارگذاری صفحه
      window.onload = fetchAllPrices;
    </script>
  </body>
</html>
