<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TF2 Key Price Checker</title>
    <!-- اتصال به Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Poppins:wght@600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Vazirmatn", sans-serif;
        background: radial-gradient(1200px 600px at 20% 10%, rgba(29,78,216,0.25), transparent 60%),
                    radial-gradient(800px 400px at 80% 90%, rgba(6,182,212,0.25), transparent 60%),
                    #0f172a;
        position: relative;
      }
      /* Animated subtle glow */
      body::before {
        content: "";
        position: fixed;
        inset: -10% -10% -10% -10%;
        background: radial-gradient(500px 500px at 10% 20%, rgba(234,88,12,0.12), transparent 60%),
                    radial-gradient(500px 500px at 90% 80%, rgba(20,184,166,0.12), transparent 60%);
        filter: blur(60px);
        animation: glow 16s ease-in-out infinite alternate;
        pointer-events: none;
        z-index: 0;
      }
      @keyframes glow {
        0% { transform: translate3d(0,0,0) scale(1); opacity: 0.8; }
        100% { transform: translate3d(0,-10px,0) scale(1.05); opacity: 1; }
      }

      /* Glassmorphism card */
      .glass-card {
        backdrop-filter: blur(10px);
        background: rgba(30, 41, 59, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 20px 40px rgba(2, 6, 23, 0.6);
      }

      /* Soft card for price boxes */
      .soft-card {
        backdrop-filter: blur(8px);
        background: rgba(17, 24, 39, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: inset 0 1px 0 rgba(255,255,255,0.05), 0 8px 24px rgba(2, 6, 23, 0.45);
      }

      /* Gradient button */
      .btn-gradient {
        background: linear-gradient(90deg, #2563eb 0%, #06b6d4 100%);
      }
      .btn-gradient:hover {
        filter: brightness(1.08);
      }
      /* استایل برای انیمیشن لودینگ */
      .loader {
        border: 4px solid #f3f3f3;
        border-radius: 50%;
        border-top: 4px solid #3498db;
        width: 40px;
        height: 40px;
        animation: spin 2s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body
    class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4"
  >
    <div
      class="w-full max-w-lg mx-auto p-8 glass-card rounded-2xl shadow-xl text-center relative z-10"
    >
      <!-- لوگو و عنوان -->
      <img
        src="https://wiki.teamfortress.com/w/images/thumb/6/69/Item_icon_Mann_Co._Supply_Crate_Key.png/250px-Item_icon_Mann_Co._Supply_Crate_Key.png"
        alt="TF2 Key"
        class="mx-auto w-24 h-24 mb-4"
        onerror="this.onerror=null;this.src='https://placehold.co/96x96/1f2937/ffffff?text=TF2+Key';"
      />

      <h1 class="text-3xl font-bold mb-2 text-yellow-400">
        Team Fortress 2 Key Price
      </h1>

      <!-- نمایشگر قیمت استیم -->
      <p class="text-gray-400 mb-2">
        Live price on Steam Market (Ukraine region)
      </p>
      <div
        id="price-display"
        class="soft-card p-6 rounded-2xl mb-6 min-h-[100px] flex items-center justify-center"
      >
        <span id="price-text" class="text-4xl font-bold text-gray-500"
          >...</span
        >
        <div id="loader" class="loader hidden"></div>
      </div>

      <!-- Net received (from live Steam price, UAH) -->
      <div class="mt-4 text-sm text-gray-300 text-left">
        <p id="net-received" class="mt-2">Net received per key: —</p>
        <p class="text-xs text-gray-400 mt-1">Computed from live Steam price (Ukraine) × 0.85.</p>
      </div>

      <!-- نمایشگر قیمت EasyKeys -->
      <div class="mt-8 border-t border-gray-700 pt-6">
        <h2 class="text-2xl font-bold mb-2 text-cyan-400">
          Price on EasyKeys.ir
        </h2>
        <div
          id="easykeys-price-display"
          class="soft-card p-6 rounded-2xl mb-6 min-h-[100px] flex items-center justify-center"
        >
          <span
            id="easykeys-price-text"
            class="text-4xl font-bold text-gray-500"
            >...</span
          >
          <div id="easykeys-loader" class="loader hidden"></div>
        </div>
        <p id="easykeys-error-message" class="text-red-500 mt-4 h-5"></p>

        <!-- Keys needed calculator -->
        <div class="mt-4 text-sm text-gray-300 text-left">
          <label for="game-price" class="block font-semibold mb-1">Game price (UAH)</label>
          <input id="game-price" type="number" step="0.01" placeholder="e.g., 1599.00" class="w-full bg-gray-700 rounded px-3 py-2 focus:outline-none" />
          <p id="keys-needed" class="mt-2">Keys needed: —</p>
          <p class="text-xs text-gray-400 mt-1">Calculated using net received per key after Steam fees.</p>
        </div>
      </div>

      <!-- دکمه برای دریافت قیمت -->
      <button
        id="fetch-price-btn"
        class="btn-gradient w-full mt-6 text-white font-bold py-3 px-4 rounded-xl transition duration-300 ease-in-out transform hover:scale-105 shadow-lg"
      >
        Refresh Prices
      </button>
    </div>

    <script>
      // المنت های صفحه (استیم)
      const fetchButton = document.getElementById("fetch-price-btn");
      const priceText = document.getElementById("price-text");
      const loader = document.getElementById("loader");

      // المنت های صفحه (EasyKeys)
      const easyKeysPriceText = document.getElementById("easykeys-price-text");
      const easyKeysErrorMessage = document.getElementById(
        "easykeys-error-message"
      );
      const easyKeysLoader = document.getElementById("easykeys-loader");

      // آدرس فانکشن ها در Netlify
      const steamApiUrl = "/.netlify/functions/getPrice";
      const easyKeysApiUrl = "/.netlify/functions/getEasyKeysPrice";

      // Fetch Steam price
      async function fetchSteamPrice() {
        priceText.classList.add("hidden");
        loader.classList.remove("hidden");

        try {
          const response = await fetch(steamApiUrl);
          const data = await response.json();
          if (!response.ok || !data.success)
            throw new Error(data.message || "Steam response was unsuccessful.");

          priceText.textContent = data.lowest_price;
          priceText.classList.remove("text-gray-500", "text-red-500");
          priceText.classList.add("text-green-400");
        } catch (error) {
          console.error("Error fetching Steam data:", error);
          priceText.textContent = "Error!";
          priceText.classList.remove("text-green-400");
          priceText.classList.add("text-red-500");
        } finally {
          loader.classList.add("hidden");
          priceText.classList.remove("hidden");
        }
      }

      // Fetch EasyKeys price
      async function fetchEasyKeysPrice() {
        easyKeysPriceText.classList.add("hidden");
        easyKeysLoader.classList.remove("hidden");
        easyKeysErrorMessage.textContent = "";

        try {
          const response = await fetch(easyKeysApiUrl);
          const data = await response.json();
          if (!response.ok || !data.success)
            throw new Error(data.message || "EasyKeys response was unsuccessful.");

          easyKeysPriceText.textContent = `${data.price} Toman`;
          easyKeysPriceText.classList.remove("text-gray-500", "text-red-500");
          easyKeysPriceText.classList.add("text-teal-300");
        } catch (error) {
          console.error("Error fetching EasyKeys data:", error);
          easyKeysErrorMessage.textContent = "Error fetching EasyKeys price.";
          easyKeysPriceText.textContent = "Error!";
          easyKeysPriceText.classList.remove("text-teal-300");
          easyKeysPriceText.classList.add("text-red-500");
        } finally {
          easyKeysLoader.classList.add("hidden");
          easyKeysPriceText.classList.remove("hidden");
        }
      }

      // Net received computation based on live Steam price (UAH)
      const netReceivedText = document.getElementById("net-received");
      const gamePriceInput = document.getElementById("game-price");
      const keysNeededText = document.getElementById("keys-needed");

      let steamBuyerPriceUAH = 0;

      function parseSteamPriceToUAH(str) {
        const numStr = String(str).replace(/[^0-9.,]/g, "").replace(",", ".");
        const num = parseFloat(numStr);
        return isNaN(num) ? 0 : num;
      }

      function updateNetFromSteam(str) {
        steamBuyerPriceUAH = parseSteamPriceToUAH(str);
        const net = steamBuyerPriceUAH * 0.85; // 15% fees total
        if (net > 0) {
          netReceivedText.textContent = `Net received per key: ${net.toFixed(2)} UAH (15% fees)`;
        } else {
          netReceivedText.textContent = "Net received per key: —";
        }
      }

      function updateKeysNeeded() {
        const net = steamBuyerPriceUAH * 0.85;
        const game = parseFloat(gamePriceInput.value || "0");
        if (!net || !game || isNaN(game) || game <= 0) {
          keysNeededText.textContent = "Keys needed: —";
          return;
        }
        const needed = Math.ceil(game / net);
        keysNeededText.textContent = `Keys needed: ${needed}`;
      }

      function fetchAllPrices() {
        fetchButton.disabled = true;
        fetchButton.classList.add("opacity-50", "cursor-not-allowed");

        // اجرای همزمان هر دو فانکشن
        Promise.all([fetchSteamPrice(), fetchEasyKeysPrice()]).finally(() => {
          fetchButton.disabled = false;
          fetchButton.classList.remove("opacity-50", "cursor-not-allowed");
          updateNetFromSteam(priceText.textContent);
          updateKeysNeeded();
        });
      }

      // افزودن رویداد کلیک به دکمه
      fetchButton.addEventListener("click", () => { fetchAllPrices(); });
      gamePriceInput.addEventListener("input", updateKeysNeeded);

      // دریافت قیمت در اولین بارگذاری صفحه
      window.onload = fetchAllPrices;
    </script>
  </body>
</html>
